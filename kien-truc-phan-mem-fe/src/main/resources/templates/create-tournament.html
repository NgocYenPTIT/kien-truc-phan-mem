<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Othello Tournament - Tạo Giải Đấu Mới</title>
  <!-- Bootstrap 4 CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <!-- Select2 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap4-theme/1.0.0/select2-bootstrap4.min.css">

  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #1abc9c;
      --accent-color: #e74c3c;
      --light-color: #ecf0f1;
      --dark-color: #2c3e50;
    }

    body {
      background-color: var(--light-color);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at top right, rgba(26, 188, 156, 0.1), transparent 70%),
      radial-gradient(circle at bottom left, rgba(44, 62, 80, 0.1), transparent 70%);
      z-index: -1;
    }

    .navbar {
      background-color: var(--primary-color);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .navbar-brand {
      font-weight: bold;
      font-size: 1.5rem;
      color: var(--light-color) !important;
    }

    .navbar-brand .game-icon {
      margin-right: 10px;
    }

    .page-header {
      background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
      color: white;
      padding: 1.5rem 0;
      margin-bottom: 2rem;
      border-radius: 0 0 15px 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .main-content {
      flex: 1;
      padding: 1rem 0 3rem;
      position: relative;
    }

    .footer {
      background-color: var(--primary-color);
      color: var(--light-color);
      padding: 1.5rem 0;
      margin-top: auto;
    }

    /* Othello piece rotating animation */
    @keyframes flip {
      0% {
        transform: rotateY(0deg);
      }
      50% {
        transform: rotateY(180deg);
      }
      100% {
        transform: rotateY(360deg);
      }
    }

    .othello-piece {
      display: inline-block;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(to right, black 50%, white 50%);
      animation: flip 3s infinite linear;
      margin-right: 10px;
      vertical-align: middle;
    }

    /* Form styles */
    .form-container {
      background-color: white;
      border-radius: 15px;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
      z-index: 1;
      transition: all 0.3s ease;
    }

    .form-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 8px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    }

    .form-container:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    }

    .form-title {
      color: var(--primary-color);
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #eee;
      position: relative;
    }

    .form-title::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 80px;
      height: 3px;
      background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
    }

    .form-group label {
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
    }

    .form-group label i {
      margin-right: 10px;
      color: var(--secondary-color);
    }

    .form-control {
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      transition: all 0.3s ease;
    }

    .form-control:focus {
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 0.2rem rgba(26, 188, 156, 0.25);
    }

    .select2-container--bootstrap4 .select2-selection--single {
      height: calc(1.5em + 1.5rem + 4px);
      padding: 0.75rem 1rem;
    }

    .select2-container--bootstrap4 .select2-selection--single .select2-selection__rendered {
      padding: 0;
      line-height: 1;
    }

    .required-field::after {
      content: '*';
      color: var(--accent-color);
      margin-left: 5px;
    }

    .btn-primary {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
      padding: 0.75rem 2rem;
      border-radius: 50px;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      z-index: 1;
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 0;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.2);
      transition: width 0.3s ease;
      z-index: -1;
    }

    .btn-primary:hover::before {
      width: 100%;
    }

    .btn-primary:hover {
      background-color: #16a085;
      border-color: #16a085;
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(22, 160, 133, 0.3);
    }

    .btn-secondary {
      background-color: #95a5a6;
      border-color: #95a5a6;
      padding: 0.75rem 2rem;
      border-radius: 50px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-secondary:hover {
      background-color: #7f8c8d;
      border-color: #7f8c8d;
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(127, 140, 141, 0.3);
    }

    .btn-icon {
      margin-right: 10px;
    }

    /* Animation for floating pieces */
    @keyframes float {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-20px);
      }
    }

    .floating-piece {
      position: absolute;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      z-index: -1;
      opacity: 0.2;
    }

    .floating-piece.black {
      background-color: #000;
    }

    .floating-piece.white {
      background-color: #fff;
      border: 1px solid #ddd;
    }

    .floating-piece:nth-child(1) {
      top: 10%;
      left: 5%;
      animation: float 8s infinite ease-in-out;
    }

    .floating-piece:nth-child(2) {
      top: 20%;
      right: 5%;
      animation: float 10s infinite ease-in-out;
    }

    .floating-piece:nth-child(3) {
      bottom: 15%;
      left: 10%;
      animation: float 7s infinite ease-in-out;
    }

    .floating-piece:nth-child(4) {
      bottom: 30%;
      right: 8%;
      animation: float 9s infinite ease-in-out;
    }

    /* Board preview animation */
    .board-preview {
      width: 100%;
      aspect-ratio: 1;
      max-width: 300px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      grid-template-rows: repeat(8, 1fr);
      border: 2px solid var(--primary-color);
      border-radius: 5px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .board-preview:hover {
      transform: scale(1.05);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
    }

    .board-cell {
      background-color: #4CAF50;
      border: 1px solid rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }

    .board-cell::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 80%;
      border-radius: 50%;
      opacity: 0;
      transition: all 0.3s ease;
    }

    .board-cell.black::after {
      background-color: #000;
      opacity: 1;
    }

    .board-cell.white::after {
      background-color: #fff;
      border: 1px solid rgba(0, 0, 0, 0.3);
      opacity: 1;
    }

    /* Board animation */
    @keyframes placeDisc {
      0% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 0;
      }
      100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
    }

    .board-cell.animated::after {
      animation: placeDisc 0.5s forwards;
    }

    /* Submit button animation */
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(26, 188, 156, 0.7);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(26, 188, 156, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(26, 188, 156, 0);
      }
    }

    .btn-submit {
      animation: pulse 2s infinite;
    }

    /* Form section animations */
    .form-section, .round-container {
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.5s ease;
    }

    .form-section.visible, .round-container.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* Past round styles */
    .opacity-75 {
      opacity: 0.75;
    }

    .opacity-75 .card {
      background-color: #f8f9fa;
    }

    /* Card styles for rounds */
    .round-container {
      margin-bottom: 40px;
    }

    .round-container .card {
      transition: all 0.3s ease;
      border-radius: 10px;
      overflow: hidden;
      border: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .round-container .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }

    .round-container .card-header {
      background: linear-gradient(to right, rgba(44, 62, 80, 0.1), rgba(26, 188, 156, 0.1));
      border-bottom: none;
    }

    /* Fixed: Custom datetime input styles */
    .date-input-group {
      display: flex;
      align-items: center;
      flex-wrap: nowrap;
      margin-bottom: 10px;
    }

    .time-input-group {
      display: flex;
      align-items: center;
      flex-wrap: nowrap;
    }

    .date-input-group input,
    .time-input-group input {
      width: auto;
      text-align: center;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin: 0 2px;
    }

    .date-input-group .day-input,
    .date-input-group .month-input {
      flex: 0 0 60px;
      max-width: 60px;
    }

    .date-input-group .year-input {
      flex: 0 0 80px;
      max-width: 80px;
    }

    .time-input-group .hour-input,
    .time-input-group .minute-input {
      flex: 0 0 60px;
      max-width: 60px;
    }

    .separator {
      margin: 0 4px;
      font-weight: bold;
      color: var(--primary-color);
    }

    .datetime-format-hint {
      font-size: 0.8rem;
      color: #6c757d;
      margin-top: 5px;
    }

    /* Validation styles */
    .is-invalid {
      border-color: #dc3545 !important;
    }

    .validation-error {
      color: #dc3545;
      font-size: 0.875rem;
      margin-top: 0.25rem;
      display: none;
    }

    .validation-error.show {
      display: block;
    }

    /* Error notification at the top of form */
    .error-notification {
      display: none;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .error-notification.show {
      display: block;
    }

    /* Summary of validation errors */
    .validation-summary {
      display: none;
      margin-bottom: 20px;
    }

    .validation-summary.show {
      display: block;
    }

    .validation-summary ul {
      margin-bottom: 0;
      padding-left: 20px;
    }

    .validation-summary li {
      margin-bottom: 5px;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .form-container {
        padding: 1.5rem;
      }

      .btn-primary, .btn-secondary {
        padding: 0.6rem 1.5rem;
      }
    }
  </style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand animate__animated animate__fadeIn" href="/home">
      <span class="othello-piece"></span> Othello Tournament
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item dropdown mr-3">
          <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="fas fa-user-circle mr-1"></i> <span th:text="${user?.username}">Username</span>
          </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdown">
            <a class="dropdown-item" href="/profile"><i class="fas fa-id-card mr-2"></i> Hồ sơ</a>
            <a class="dropdown-item" href="/settings"><i class="fas fa-cog mr-2"></i> Cài đặt</a>
            <div class="dropdown-divider"></div>
            <form th:action="@{/logout}" method="post">
              <button type="submit" class="dropdown-item"><i class="fas fa-sign-out-alt mr-2"></i> Đăng xuất</button>
            </form>
          </div>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- Page Header -->
<header class="page-header animate__animated animate__fadeIn">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center">
      <h2><i class="fas fa-plus-circle mr-2"></i> Tạo Giải Đấu Mới</h2>
      <a href="/tournament" class="btn btn-outline-light">
        <i class="fas fa-arrow-left mr-2"></i> Quay lại
      </a>
    </div>
  </div>
</header>

<!-- Main Content -->
<main class="main-content">
  <!-- Floating animation elements -->
  <div class="floating-piece black"></div>
  <div class="floating-piece white"></div>
  <div class="floating-piece black"></div>
  <div class="floating-piece white"></div>

  <div class="container">
    <div class="form-container animate__animated animate__fadeIn">
      <!-- Error notification -->
      <div class="alert alert-danger alert-dismissible fade show error-notification" id="errorNotification" role="alert">
        <h5><i class="fas fa-exclamation-triangle mr-2"></i> Vui lòng kiểm tra lại thông tin</h5>
        <div class="validation-summary" id="validationSummary">
          <ul id="errorList"></ul>
        </div>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <h3 class="form-title text-center"><i class="fas fa-trophy mr-2"></i> Thông tin giải đấu</h3>

      <form id="createTournamentForm" th:action="@{/tournament/create}" method="post" class="needs-validation" novalidate>

        <!-- Basic Information Section -->
        <div class="form-section visible" id="section-basic">
          <div class="row mb-4">
            <div class="col-md-8">
              <div class="form-group">
                <label for="name" class="required-field"><i class="fas fa-font"></i> Tên giải đấu</label>
                <input type="text" class="form-control" id="name" name="name" placeholder="Nhập tên giải đấu" required>
                <div class="validation-error" id="nameError">Vui lòng nhập tên giải đấu</div>
              </div>

              <div class="form-group">
                <label for="description"><i class="fas fa-align-left"></i> Mô tả</label>
                <textarea class="form-control" id="description" name="description" rows="3" placeholder="Mô tả chi tiết về giải đấu"></textarea>
              </div>
            </div>
            <div class="col-md-4">
              <div class="board-type-preview text-center">
                <h5 class="mb-3"><i class="fas fa-chess-board mr-2"></i> Bàn cờ</h5>
                <div class="board-preview mb-3">
                  <!-- Board cells will be generated by JS -->
                </div>
                <div class="badge badge-primary p-2">Bàn cờ 8x8</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tournament Settings Section -->
        <div class="form-section" id="section-settings">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="boardTypeId"><i class="fas fa-chess-board"></i> Loại bàn cờ</label>
                <select class="form-control select2" id="boardTypeId" name="boardTypeId">
                  <option value="1" selected>Bàn cờ 8x8 (Tiêu chuẩn)</option>
                </select>
              </div>

              <div class="form-group">
                <label for="organizingMethodId"><i class="fas fa-sitemap"></i> Số vòng đấu</label>
                <select class="form-control select2" id="organizingMethodId" name="organizingMethodId">
                  <option value="1">7 vòng</option>
                  <option value="2">9 vòng</option>
                  <option value="3">11 vòng</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="maxPlayer" class="required-field"><i class="fas fa-users"></i> Số người tham gia tối đa</label>
                <input type="number" class="form-control" id="maxPlayer" name="maxPlayer" min="2" step="1" value="8" required>
                <div class="validation-error" id="maxPlayerError">Vui lòng nhập số người tham gia tối đa (ít nhất 2 người)</div>
              </div>

              <div class="form-group">
                <div class="custom-control custom-switch">
                  <input type="checkbox" class="custom-control-input" id="autoApprove" name="autoApprove">
                  <label class="custom-control-label" for="autoApprove">Tự động chấp nhận người tham gia</label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tournament Time Settings Section -->
        <div class="form-section" id="section-time">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="startDate" class="required-field"><i class="far fa-calendar-alt"></i> Thời gian bắt đầu giải đấu</label>
                <!-- Hidden input for actual datetime value -->
                <input type="hidden" id="startDate" name="startDate" required>

                <div class="date-time-inputs" id="startDateInputs">
                  <div class="date-input-group">
                    <input type="number" class="form-control day-input" placeholder="DD" min="1" max="31" required>
                    <div class="separator">/</div>
                    <input type="number" class="form-control month-input" placeholder="MM" min="1" max="12" required>
                    <div class="separator">/</div>
                    <input type="number" class="form-control year-input" placeholder="YYYY" min="2025" max="2030" required>
                  </div>
                  <div class="time-input-group">
                    <input type="number" class="form-control hour-input" placeholder="HH" min="0" max="23" required>
                    <div class="separator">:</div>
                    <input type="number" class="form-control minute-input" placeholder="MM" min="0" max="59" required>
                  </div>
                </div>
                <div class="datetime-format-hint">Định dạng: DD/MM/YYYY HH:MM</div>
                <div class="validation-error" id="startDateError">Vui lòng nhập thời gian bắt đầu hợp lệ</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="endDate" class="required-field"><i class="far fa-calendar-check"></i> Thời gian kết thúc giải đấu</label>
                <!-- Hidden input for actual datetime value -->
                <input type="hidden" id="endDate" name="endDate" required>

                <div class="date-time-inputs" id="endDateInputs">
                  <div class="date-input-group">
                    <input type="number" class="form-control day-input" placeholder="DD" min="1" max="31" required>
                    <div class="separator">/</div>
                    <input type="number" class="form-control month-input" placeholder="MM" min="1" max="12" required>
                    <div class="separator">/</div>
                    <input type="number" class="form-control year-input" placeholder="YYYY" min="2025" max="2030" required>
                  </div>
                  <div class="time-input-group">
                    <input type="number" class="form-control hour-input" placeholder="HH" min="0" max="23" required>
                    <div class="separator">:</div>
                    <input type="number" class="form-control minute-input" placeholder="MM" min="0" max="59" required>
                  </div>
                </div>
                <div class="datetime-format-hint">Định dạng: DD/MM/YYYY HH:MM</div>
                <div class="validation-error" id="endDateError">Vui lòng nhập thời gian kết thúc hợp lệ</div>
              </div>
            </div>
          </div>
          <div class="validation-error" id="dateRangeError">Thời gian kết thúc phải sau thời gian bắt đầu</div>
        </div>

        <!-- Rounds Time Settings Section -->
        <div class="form-section" id="section-rounds">
          <h4 class="mb-4 text-center"><i class="fas fa-chess-clock mr-2"></i> Lịch trình vòng đấu</h4>
          <div class="alert alert-info mb-4">
            <i class="fas fa-info-circle mr-2"></i> Thời gian cho từng vòng đấu phải nằm trong khoảng thời gian của giải đấu.
          </div>

          <div id="roundsContainer">
            <!-- Round time inputs will be generated here dynamically -->
          </div>
        </div>

        <!-- Hidden fields -->
        <input type="hidden" name="organizerId" id="organizerId" th:value="${user?.id}">

        <!-- Form Actions -->
        <div class="form-section visible" id="section-actions">
          <div class="d-flex justify-content-between mt-4">
            <a href="/tournament" class="btn btn-secondary">
              <i class="fas fa-times btn-icon"></i> Huỷ
            </a>
            <button type="submit" class="btn btn-primary btn-submit">
              <i class="fas fa-plus-circle btn-icon"></i> Tạo giải đấu
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</main>

<!-- Footer -->
<footer class="footer">
  <div class="container text-center">
    <p class="mb-0">© 2025 Othello Tournament Manager. Tất cả các quyền được bảo lưu.</p>
  </div>
</footer>

<!-- JavaScript Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.full.min.js"></script>

<script>
  $(document).ready(function() {
    // Animate form sections
    setTimeout(function() {
      $('#section-settings').addClass('visible');
    }, 300);

    setTimeout(function() {
      $('#section-time').addClass('visible');
    }, 600);

    setTimeout(function() {
      $('#section-rounds').addClass('visible');
    }, 900);

    // Initialize Select2
    $('.select2').select2({
      theme: 'bootstrap4',
      width: '100%'
    });

    // Setup datetime inputs
    setupDateTimeInputs('#startDateInputs', '#startDate');
    setupDateTimeInputs('#endDateInputs', '#endDate');

    // Handle round selection change
    $('#organizingMethodId').on('change', function() {
      generateRoundInputs();
    });

    // Initial generation of round inputs
    generateRoundInputs();

    // Generate Othello board preview
    generateBoardPreview();

    // Animate board preview with discs
    animateBoardPreview();

    // Set up real-time validation for required fields
    $('#name').on('input', function() {
      validateField($(this), $('#nameError'), function(value) {
        return value.trim() !== '';
      }, 'Vui lòng nhập tên giải đấu');
    });

    $('#maxPlayer').on('input', function() {
      validateField($(this), $('#maxPlayerError'), function(value) {
        const num = parseInt(value);
        return !isNaN(num) && num >= 2;
      }, 'Vui lòng nhập số người tham gia tối đa (ít nhất 2 người)');
    });

    // Add input validation for datetime fields
    $('#startDateInputs input, #endDateInputs input').on('input', function() {
      validateDateTimeInput($(this));
    });

    // Validate date range whenever either date changes
    $('#startDateInputs input, #endDateInputs input').on('change', function() {
      validateDateRange();
    });

    // Form validation
    $('#createTournamentForm').on('submit', function(event) {
      // Update all hidden inputs with formatted date values
      updateAllDateInputs();

      // Clear previous errors
      resetValidationErrors();

      if (!validateForm()) {
        event.preventDefault();
        return false;
      }

      // If validation passes, show loading state
      $('.btn-submit').html('<i class="fas fa-spinner fa-spin mr-2"></i> Đang xử lý...');
      $('.btn-submit').attr('disabled', true);
      return true;
    });
  });

  // Clear all validation errors
  function resetValidationErrors() {
    $('.validation-error').removeClass('show');
    $('.form-control').removeClass('is-invalid');
    $('#errorList').empty();
    $('#errorNotification').removeClass('show');
    $('#validationSummary').removeClass('show');
  }

  // Show validation error
  function showValidationError(inputElement, errorElement, message) {
    inputElement.addClass('is-invalid');
    errorElement.text(message).addClass('show');

    // Add to error summary if not already there
    let errorExists = false;
    $('#errorList li').each(function() {
      if ($(this).text() === message) {
        errorExists = true;
        return false;
      }
    });

    if (!errorExists) {
      $('#errorList').append(`<li>${message}</li>`);
      $('#errorNotification').addClass('show');
      $('#validationSummary').addClass('show');
    }
  }

  // Clear validation error
  function clearValidationError(inputElement, errorElement) {
    inputElement.removeClass('is-invalid');
    errorElement.removeClass('show');

    // Remove from error summary if exists
    const message = errorElement.text();
    $('#errorList li').each(function() {
      if ($(this).text() === message) {
        $(this).remove();
        return false;
      }
    });

    if ($('#errorList li').length === 0) {
      $('#errorNotification').removeClass('show');
      $('#validationSummary').removeClass('show');
    }
  }

  // Setup DateTime Inputs
  function setupDateTimeInputs(containerSelector, hiddenInputSelector) {
    const container = $(containerSelector);
    const today = new Date();

    // Set default values (today + 1 hour)
    if (containerSelector === '#startDateInputs') {
      container.find('.day-input').val(today.getDate());
      container.find('.month-input').val(today.getMonth() + 1);
      container.find('.year-input').val(today.getFullYear());
      container.find('.hour-input').val(today.getHours());
      container.find('.minute-input').val(0);
    }
    // For end date, set default to today + 7 days
    else if (containerSelector === '#endDateInputs') {
      const endDate = new Date();
      endDate.setDate(today.getDate() + 7);

      container.find('.day-input').val(endDate.getDate());
      container.find('.month-input').val(endDate.getMonth() + 1);
      container.find('.year-input').val(endDate.getFullYear());
      container.find('.hour-input').val(18); // Default to 6 PM
      container.find('.minute-input').val(0);
    }

    // Update hidden input when any date/time value changes
    container.find('input').on('change', function() {
      updateDateInput(containerSelector, hiddenInputSelector);
    });

    // Initial update
    updateDateInput(containerSelector, hiddenInputSelector);
  }

  // Update date hidden input based on individual inputs
  function updateDateInput(containerSelector, hiddenInputSelector) {
    const container = $(containerSelector);
    const day = container.find('.day-input').val();
    const month = container.find('.month-input').val();
    const year = container.find('.year-input').val();
    const hour = container.find('.hour-input').val();
    const minute = container.find('.minute-input').val();

    // Only update if all values are present
    if (day && month && year && hour && minute) {
      const formattedDate = `${padZero(day)}/${padZero(month)}/${year} ${padZero(hour)}:${padZero(minute)}`;
      $(hiddenInputSelector).val(formattedDate);
    }
  }

  // Update all date inputs before form submission
  function updateAllDateInputs() {
    updateDateInput('#startDateInputs', '#startDate');
    updateDateInput('#endDateInputs', '#endDate');

    // Update all round date inputs
    $('.round-datetime-container').each(function() {
      const containerId = $(this).attr('id');
      const hiddenInputId = containerId.replace('Inputs', '');
      updateDateInput(`#${containerId}`, `#${hiddenInputId}`);
    });
  }

  // Add leading zero to numbers less than 10
  function padZero(num) {
    return num < 10 ? '0' + num : num;
  }

  // Validate a single field
  function validateField(inputElement, errorElement, validationFunc, errorMessage) {
    const value = inputElement.val();
    if (!validationFunc(value)) {
      showValidationError(inputElement, errorElement, errorMessage);
      return false;
    } else {
      clearValidationError(inputElement, errorElement);
      return true;
    }
  }

  // Validate datetime input fields
  function validateDateTimeInput(inputElement) {
    const value = inputElement.val();
    const min = parseInt(inputElement.attr('min'));
    const max = parseInt(inputElement.attr('max'));

    if (value === '' || isNaN(parseInt(value))) {
      inputElement.addClass('is-invalid');
      return false;
    }

    const numValue = parseInt(value);
    if (numValue < min || numValue > max) {
      inputElement.addClass('is-invalid');
      return false;
    }

    inputElement.removeClass('is-invalid');
    return true;
  }

  // Validate the date range
  function validateDateRange() {
    const startDate = $('#startDate').val();
    const endDate = $('#endDate').val();

    if (!startDate || !endDate) return;

    const startMoment = moment(startDate, 'DD/MM/YYYY HH:mm');
    const endMoment = moment(endDate, 'DD/MM/YYYY HH:mm');

    if (!startMoment.isValid() || !endMoment.isValid()) return;

    if (endMoment.isSameOrBefore(startMoment)) {
      showValidationError($('#endDateInputs'), $('#dateRangeError'), 'Thời gian kết thúc phải sau thời gian bắt đầu');
      return false;
    } else {
      clearValidationError($('#endDateInputs'), $('#dateRangeError'));
      return true;
    }
  }

  // Validate round dates against tournament timeframe
  function validateRoundDates(tournamentStartMoment, tournamentEndMoment) {
    let isValid = true;
    const errors = [];

    $('.round-container').each(function() {
      // Skip past rounds that are disabled
      if ($(this).hasClass('opacity-75')) {
        return;
      }

      const roundId = $(this).find('input[type="hidden"]').first().attr('id');
      const roundName = roundId.replace('StartDate', '');
      const roundNum = roundName.replace('round', '');

      const roundStartDate = $(`#${roundId}`).val();
      const roundEndDate = $(`#${roundName}EndDate`).val();

      if (!isValidDateTimeFormat(roundStartDate) || !isValidDateTimeFormat(roundEndDate)) {
        showValidationError($(`#${roundName}StartDateInputs`),
                $(`#${roundName}StartDateInputs`).siblings('.validation-error'),
                `Vui lòng nhập đúng định dạng ngày giờ cho Vòng ${roundNum}`);
        errors.push(`Vui lòng nhập đúng định dạng ngày giờ cho Vòng ${roundNum}`);
        isValid = false;
        return;
      }

      const roundStartMoment = moment(roundStartDate, 'DD/MM/YYYY HH:mm');
      const roundEndMoment = moment(roundEndDate, 'DD/MM/YYYY HH:mm');

      if (roundEndMoment.isSameOrBefore(roundStartMoment)) {
        showValidationError($(`#${roundName}EndDateInputs`),
                $(`#${roundName}EndDateInputs`).siblings('.validation-error'),
                `Thời gian kết thúc phải sau thời gian bắt đầu cho Vòng ${roundNum}`);
        errors.push(`Thời gian kết thúc phải sau thời gian bắt đầu cho Vòng ${roundNum}`);
        isValid = false;
        return;
      }

      // Check if round dates are within tournament timeframe
      if (roundStartMoment.isBefore(tournamentStartMoment)) {
        showValidationError($(`#${roundName}StartDateInputs`),
                $(`#${roundName}StartDateInputs`).siblings('.validation-error'),
                `Thời gian bắt đầu Vòng ${roundNum} phải sau thời gian bắt đầu giải đấu`);
        errors.push(`Thời gian bắt đầu Vòng ${roundNum} phải sau thời gian bắt đầu giải đấu`);
        isValid = false;
      }

      if (roundEndMoment.isAfter(tournamentEndMoment)) {
        showValidationError($(`#${roundName}EndDateInputs`),
                $(`#${roundName}EndDateInputs`).siblings('.validation-error'),
                `Thời gian kết thúc Vòng ${roundNum} phải trước thời gian kết thúc giải đấu`);
        errors.push(`Thời gian kết thúc Vòng ${roundNum} phải trước thời gian kết thúc giải đấu`);
        isValid = false;
      }
    });

    return isValid;
  }

  // Generate Othello board preview
  function generateBoardPreview() {
    const boardPreview = $('.board-preview');
    boardPreview.empty();

    // Create 8x8 board
    for (let i = 0; i < 8; i++) {
      for (let j = 0; j < 8; j++) {
        const cell = $('<div class="board-cell"></div>');
        boardPreview.append(cell);
      }
    }

    // Set initial discs (standard Othello setup)
    const cells = boardPreview.find('.board-cell');
    cells.eq(27).addClass('white');
    cells.eq(28).addClass('black');
    cells.eq(35).addClass('black');
    cells.eq(36).addClass('white');
  }

  // Animate board preview with random disc placements
  function animateBoardPreview() {
    const cells = $('.board-preview .board-cell');
    const availableCells = [];

    // Find empty cells
    cells.each(function(index) {
      if (!$(this).hasClass('white') && !$(this).hasClass('black')) {
        availableCells.push(index);
      }
    });

    // Shuffle available cells
    availableCells.sort(() => Math.random() - 0.5);

    // Animate disc placements
    let counter = 0;
    const interval = setInterval(function() {
      if (counter >= 10 || availableCells.length === 0) {
        clearInterval(interval);
        setTimeout(resetBoardAnimation, 3000);
        return;
      }

      const cellIndex = availableCells.pop();
      const color = Math.random() > 0.5 ? 'white' : 'black';

      cells.eq(cellIndex).addClass(color + ' animated');
      counter++;
    }, 600);
  }

  // Reset board animation
  function resetBoardAnimation() {
    const cells = $('.board-preview .board-cell');

    // Reset to initial state
    cells.removeClass('white black animated');

    cells.eq(27).addClass('white');
    cells.eq(28).addClass('black');
    cells.eq(35).addClass('black');
    cells.eq(36).addClass('white');

    // Start new animation after delay
    setTimeout(animateBoardPreview, 1000);
  }

  // Generate inputs for rounds based on selection
  function generateRoundInputs() {
    const roundsContainer = $('#roundsContainer');
    roundsContainer.empty();

    const numRounds = parseInt($('#organizingMethodId').val(), 10);
    let rounds = 0;

    switch(numRounds) {
      case 1:
        rounds = 7;
        break;
      case 2:
        rounds = 9;
        break;
      case 3:
        rounds = 11;
        break;
      default:
        rounds = 7;
    }

    // Get tournament start and end dates as reference
    const tournamentStartDate = $('#startDate').val();
    const tournamentEndDate = $('#endDate').val();

    // Generate time inputs for each round
    for (let i = 1; i <= rounds; i++) {
      // For demo, set some rounds as completed (past) and others as editable
      const isPastRound = i <= 2; // Just for demonstration - first 2 rounds are "past"
      const isDisabled = isPastRound ? 'disabled' : '';
      const statusBadge = isPastRound ?
              '<span class="badge badge-secondary ml-2">Đã diễn ra</span>' :
              '<span class="badge badge-primary ml-2">Có thể chỉnh sửa</span>';

      // Calculate suggested dates for this round
      const startDateStr = isPastRound ? `01/0${i}/2025 10:00` : '';
      const endDateStr = isPastRound ? `05/0${i}/2025 18:00` : '';

      const roundHtml = `
        <div class="round-container mb-4 ${isPastRound ? 'opacity-75' : ''}">
          <div class="card">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <i class="fas fa-flag-checkered mr-2"></i> Vòng ${i} ${statusBadge}
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="round${i}StartDate" class="required-field">
                      <i class="far fa-calendar-alt"></i> Thời gian bắt đầu
                    </label>
                    <!-- Hidden input for actual datetime value -->
                    <input type="hidden" id="round${i}StartDate" name="rounds[${i-1}].startDate" value="${startDateStr}" ${isDisabled} required>

                    <div class="date-time-inputs round-datetime-container" id="round${i}StartDateInputs">
                      <div class="date-input-group">
                        <input type="number" class="form-control day-input" placeholder="DD" min="1" max="31" ${isDisabled} required>
                        <div class="separator">/</div>
                        <input type="number" class="form-control month-input" placeholder="MM" min="1" max="12" ${isDisabled} required>
                        <div class="separator">/</div>
                        <input type="number" class="form-control year-input" placeholder="YYYY" min="2025" max="2030" ${isDisabled} required>
                      </div>
                      <div class="time-input-group">
                        <input type="number" class="form-control hour-input" placeholder="HH" min="0" max="23" ${isDisabled} required>
                        <div class="separator">:</div>
                        <input type="number" class="form-control minute-input" placeholder="MM" min="0" max="59" ${isDisabled} required>
                      </div>
                    </div>
                    <div class="datetime-format-hint">Định dạng: DD/MM/YYYY HH:MM</div>
                    <div class="validation-error" id="round${i}StartDateError">Vui lòng nhập thời gian bắt đầu hợp lệ</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="round${i}EndDate" class="required-field">
                      <i class="far fa-calendar-check"></i> Thời gian kết thúc
                    </label>
                    <!-- Hidden input for actual datetime value -->
                    <input type="hidden" id="round${i}EndDate" name="rounds[${i-1}].endDate" value="${endDateStr}" ${isDisabled} required>

                    <div class="date-time-inputs round-datetime-container" id="round${i}EndDateInputs">
                      <div class="date-input-group">
                        <input type="number" class="form-control day-input" placeholder="DD" min="1" max="31" ${isDisabled} required>
                        <div class="separator">/</div>
                        <input type="number" class="form-control month-input" placeholder="MM" min="1" max="12" ${isDisabled} required>
                        <div class="separator">/</div>
                        <input type="number" class="form-control year-input" placeholder="YYYY" min="2025" max="2030" ${isDisabled} required>
                      </div>
                      <div class="time-input-group">
                        <input type="number" class="form-control hour-input" placeholder="HH" min="0" max="23" ${isDisabled} required>
                        <div class="separator">:</div>
                        <input type="number" class="form-control minute-input" placeholder="MM" min="0" max="59" ${isDisabled} required>
                      </div>
                    </div>
                    <div class="datetime-format-hint">Định dạng: DD/MM/YYYY HH:MM</div>
                    <div class="validation-error" id="round${i}EndDateError">Vui lòng nhập thời gian kết thúc hợp lệ</div>
                  </div>
                </div>
              </div>
              <div class="validation-error" id="round${i}DateRangeError">Thời gian kết thúc vòng đấu phải sau thời gian bắt đầu vòng đấu</div>
            </div>
          </div>
        </div>
      `;

      roundsContainer.append(roundHtml);

      // Initialize past round values
      if (isPastRound) {
        // Parse the sample date
        if (startDateStr) {
          const [startDate, startTime] = startDateStr.split(' ');
          const [startDay, startMonth, startYear] = startDate.split('/');
          const [startHour, startMinute] = startTime.split(':');

          $(`#round${i}StartDateInputs .day-input`).val(parseInt(startDay));
          $(`#round${i}StartDateInputs .month-input`).val(parseInt(startMonth));
          $(`#round${i}StartDateInputs .year-input`).val(parseInt(startYear));
          $(`#round${i}StartDateInputs .hour-input`).val(parseInt(startHour));
          $(`#round${i}StartDateInputs .minute-input`).val(parseInt(startMinute));
        }

        if (endDateStr) {
          const [endDate, endTime] = endDateStr.split(' ');
          const [endDay, endMonth, endYear] = endDate.split('/');
          const [endHour, endMinute] = endTime.split(':');

          $(`#round${i}EndDateInputs .day-input`).val(parseInt(endDay));
          $(`#round${i}EndDateInputs .month-input`).val(parseInt(endMonth));
          $(`#round${i}EndDateInputs .year-input`).val(parseInt(endYear));
          $(`#round${i}EndDateInputs .hour-input`).val(parseInt(endHour));
          $(`#round${i}EndDateInputs .minute-input`).val(parseInt(endMinute));
        }
      } else {
        // Setup event handlers for editable rounds
        setupDateTimeInputs(`#round${i}StartDateInputs`, `#round${i}StartDate`);
        setupDateTimeInputs(`#round${i}EndDateInputs`, `#round${i}EndDate`);

        // Add validation for editable rounds
        $(`#round${i}StartDateInputs input, #round${i}EndDateInputs input`).on('input', function() {
          validateDateTimeInput($(this));
        });

        // Validate date range whenever either date changes
        $(`#round${i}StartDateInputs input, #round${i}EndDateInputs input`).on('change', function() {
          validateRoundDateRange(i);
        });
      }
    }

    // Add animation to newly added elements
    $('.round-container').each(function(index) {
      const element = $(this);
      setTimeout(function() {
        element.addClass('visible');
      }, 200 * index);
    });
  }

  // Validate datetime format
  function isValidDateTimeFormat(dateTimeStr) {
    if (!dateTimeStr) return false;

    // Format: DD/MM/YYYY HH:MM
    const regex = /^\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}$/;
    return regex.test(dateTimeStr);
  }

  // Validate round date range
  function validateRoundDateRange(roundNumber) {
    const startDate = $(`#round${roundNumber}StartDate`).val();
    const endDate = $(`#round${roundNumber}EndDate`).val();

    if (!startDate || !endDate) return;

    const startMoment = moment(startDate, 'DD/MM/YYYY HH:mm');
    const endMoment = moment(endDate, 'DD/MM/YYYY HH:mm');

    if (!startMoment.isValid() || !endMoment.isValid()) return;

    if (endMoment.isSameOrBefore(startMoment)) {
      showValidationError($(`#round${roundNumber}EndDateInputs`),
              $(`#round${roundNumber}DateRangeError`),
              `Thời gian kết thúc Vòng ${roundNumber} phải sau thời gian bắt đầu`);
      return false;
    } else {
      clearValidationError($(`#round${roundNumber}EndDateInputs`),
              $(`#round${roundNumber}DateRangeError`));

      // Check if round dates are within tournament timeframe
      const tournamentStartDate = $('#startDate').val();
      const tournamentEndDate = $('#endDate').val();

      if (!tournamentStartDate || !tournamentEndDate) return true;

      const tournamentStartMoment = moment(tournamentStartDate, 'DD/MM/YYYY HH:mm');
      const tournamentEndMoment = moment(tournamentEndDate, 'DD/MM/YYYY HH:mm');

      if (!tournamentStartMoment.isValid() || !tournamentEndMoment.isValid()) return true;

      if (startMoment.isBefore(tournamentStartMoment)) {
        showValidationError($(`#round${roundNumber}StartDateInputs`),
                $(`#round${roundNumber}StartDateError`),
                `Thời gian bắt đầu Vòng ${roundNumber} phải sau thời gian bắt đầu giải đấu`);
        return false;
      } else {
        clearValidationError($(`#round${roundNumber}StartDateInputs`),
                $(`#round${roundNumber}StartDateError`));
      }

      if (endMoment.isAfter(tournamentEndMoment)) {
        showValidationError($(`#round${roundNumber}EndDateInputs`),
                $(`#round${roundNumber}EndDateError`),
                `Thời gian kết thúc Vòng ${roundNumber} phải trước thời gian kết thúc giải đấu`);
        return false;
      } else {
        clearValidationError($(`#round${roundNumber}EndDateInputs`),
                $(`#round${roundNumber}EndDateError`));
      }

      return true;
    }
  }

  // Custom validation function
  function validateForm() {
    let isValid = true;

    // Validate tournament name
    if (!validateField($('#name'), $('#nameError'), function(value) {
      return value.trim() !== '';
    }, 'Vui lòng nhập tên giải đấu')) {
      isValid = false;
    }

    // Validate max players
    if (!validateField($('#maxPlayer'), $('#maxPlayerError'), function(value) {
      const num = parseInt(value);
      return !isNaN(num) && num >= 2;
    }, 'Vui lòng nhập số người tham gia tối đa (ít nhất 2 người)')) {
      isValid = false;
    }

    // Validate tournament dates
    updateDateInput('#startDateInputs', '#startDate');
    updateDateInput('#endDateInputs', '#endDate');

    const startDate = $('#startDate').val();
    const endDate = $('#endDate').val();

    if (!isValidDateTimeFormat(startDate)) {
      showValidationError($('#startDateInputs'), $('#startDateError'), 'Vui lòng nhập đúng định dạng ngày giờ');
      isValid = false;
    } else {
      clearValidationError($('#startDateInputs'), $('#startDateError'));
    }

    if (!isValidDateTimeFormat(endDate)) {
      showValidationError($('#endDateInputs'), $('#endDateError'), 'Vui lòng nhập đúng định dạng ngày giờ');
      isValid = false;
    } else {
      clearValidationError($('#endDateInputs'), $('#endDateError'));
    }

    // Validate date range
    if (isValidDateTimeFormat(startDate) && isValidDateTimeFormat(endDate)) {
      const startMoment = moment(startDate, 'DD/MM/YYYY HH:mm');
      const endMoment = moment(endDate, 'DD/MM/YYYY HH:mm');

      if (endMoment.isSameOrBefore(startMoment)) {
        showValidationError($('#endDateInputs'), $('#dateRangeError'), 'Thời gian kết thúc phải sau thời gian bắt đầu');
        isValid = false;
      } else {
        clearValidationError($('#endDateInputs'), $('#dateRangeError'));

        // Validate round dates against tournament timeframe
        if (!validateRoundDates(startMoment, endMoment)) {
          isValid = false;
        }
      }
    }

    if (!isValid) {
      // Scroll to first error
      $('html, body').animate({
        scrollTop: $('.validation-error.show').first().offset().top - 100
      }, 500);
    }

    return isValid;
  }
</script>
</body>
</html>